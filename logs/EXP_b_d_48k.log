>>>> Flash Attention installed
>>>> Flash RoPE installed
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:05<00:05,  5.05s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:06<00:00,  3.08s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:06<00:00,  3.38s/it]
Resolving data files:   0%|          | 0/23 [00:00<?, ?it/s]Resolving data files:   4%|▍         | 1/23 [00:00<00:10,  2.10it/s]Resolving data files:  22%|██▏       | 5/23 [00:00<00:01,  9.54it/s]Resolving data files:  83%|████████▎ | 19/23 [00:00<00:00, 38.72it/s]Resolving data files: 100%|██████████| 23/23 [00:00<00:00, 31.18it/s]
/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/datasets/table.py:1421: FutureWarning: promote has been superseded by mode='default'.
  table = cls._concat_blocks(blocks, axis=0)
  0%|          | 0/1 [00:00<?, ?it/s]100%|██████████| 1/1 [00:08<00:00,  8.71s/it]100%|██████████| 1/1 [00:08<00:00,  8.71s/it]
  0%|          | 0/1 [00:00<?, ?it/s]100%|██████████| 1/1 [00:11<00:00, 11.08s/it]100%|██████████| 1/1 [00:11<00:00, 11.08s/it]
  0%|          | 0/480 [00:00<?, ?it/s]  0%|          | 1/480 [00:00<03:15,  2.45it/s]  1%|          | 5/480 [00:00<00:41, 11.48it/s]  2%|▏         | 9/480 [00:00<00:26, 17.87it/s]  3%|▎         | 13/480 [00:00<00:20, 22.36it/s]  4%|▎         | 17/480 [00:00<00:18, 25.49it/s]  4%|▍         | 21/480 [00:01<00:16, 27.56it/s]  5%|▌         | 25/480 [00:01<00:15, 29.14it/s]  6%|▌         | 29/480 [00:01<00:14, 30.20it/s]  7%|▋         | 33/480 [00:01<00:14, 30.98it/s]  8%|▊         | 37/480 [00:01<00:14, 31.49it/s]  9%|▊         | 41/480 [00:01<00:13, 31.79it/s]  9%|▉         | 45/480 [00:01<00:13, 31.91it/s] 10%|█         | 49/480 [00:01<00:13, 31.91it/s] 11%|█         | 53/480 [00:02<00:13, 31.82it/s] 12%|█▏        | 57/480 [00:02<00:13, 31.66it/s] 13%|█▎        | 61/480 [00:02<00:13, 31.45it/s] 14%|█▎        | 65/480 [00:02<00:13, 31.20it/s] 14%|█▍        | 69/480 [00:02<00:13, 30.94it/s] 15%|█▌        | 73/480 [00:02<00:13, 30.66it/s] 16%|█▌        | 77/480 [00:02<00:13, 30.38it/s] 17%|█▋        | 81/480 [00:02<00:13, 30.01it/s] 18%|█▊        | 85/480 [00:03<00:13, 29.77it/s] 18%|█▊        | 88/480 [00:03<00:13, 29.59it/s] 19%|█▉        | 91/480 [00:03<00:13, 29.39it/s] 20%|█▉        | 94/480 [00:03<00:13, 29.19it/s] 20%|██        | 97/480 [00:03<00:13, 28.97it/s] 21%|██        | 100/480 [00:03<00:13, 28.76it/s] 21%|██▏       | 103/480 [00:03<00:13, 28.55it/s] 22%|██▏       | 106/480 [00:03<00:13, 28.34it/s] 23%|██▎       | 109/480 [00:03<00:13, 28.14it/s] 23%|██▎       | 112/480 [00:04<00:13, 27.97it/s] 24%|██▍       | 115/480 [00:04<00:13, 27.82it/s] 25%|██▍       | 118/480 [00:04<00:13, 27.64it/s] 25%|██▌       | 121/480 [00:04<00:13, 27.45it/s] 26%|██▌       | 124/480 [00:04<00:13, 27.22it/s] 26%|██▋       | 127/480 [00:04<00:13, 27.04it/s] 27%|██▋       | 130/480 [00:04<00:13, 26.86it/s] 28%|██▊       | 133/480 [00:04<00:13, 26.65it/s] 28%|██▊       | 136/480 [00:04<00:13, 26.32it/s] 29%|██▉       | 139/480 [00:05<00:13, 26.19it/s] 30%|██▉       | 142/480 [00:05<00:12, 26.02it/s] 30%|███       | 145/480 [00:05<00:12, 25.87it/s] 31%|███       | 148/480 [00:05<00:12, 25.71it/s] 31%|███▏      | 151/480 [00:05<00:12, 25.55it/s] 32%|███▏      | 154/480 [00:05<00:12, 25.42it/s] 33%|███▎      | 157/480 [00:05<00:12, 25.27it/s] 33%|███▎      | 160/480 [00:05<00:12, 25.11it/s] 34%|███▍      | 163/480 [00:05<00:12, 24.97it/s] 35%|███▍      | 166/480 [00:06<00:12, 24.80it/s] 35%|███▌      | 169/480 [00:06<00:12, 24.65it/s] 36%|███▌      | 172/480 [00:06<00:12, 24.51it/s] 36%|███▋      | 175/480 [00:06<00:12, 24.36it/s] 37%|███▋      | 178/480 [00:06<00:12, 24.23it/s] 38%|███▊      | 181/480 [00:06<00:12, 24.09it/s] 38%|███▊      | 184/480 [00:06<00:12, 23.95it/s] 39%|███▉      | 187/480 [00:06<00:12, 23.81it/s] 40%|███▉      | 190/480 [00:07<00:12, 23.68it/s] 40%|████      | 193/480 [00:07<00:12, 23.55it/s] 41%|████      | 196/480 [00:07<00:12, 23.40it/s] 41%|████▏     | 199/480 [00:07<00:12, 23.28it/s] 42%|████▏     | 202/480 [00:07<00:12, 23.15it/s] 43%|████▎     | 205/480 [00:07<00:11, 23.01it/s] 43%|████▎     | 208/480 [00:07<00:11, 22.90it/s] 44%|████▍     | 211/480 [00:08<00:11, 22.76it/s] 45%|████▍     | 214/480 [00:08<00:11, 22.63it/s] 45%|████▌     | 217/480 [00:08<00:11, 22.51it/s] 46%|████▌     | 220/480 [00:08<00:11, 22.41it/s] 46%|████▋     | 223/480 [00:08<00:11, 22.30it/s] 47%|████▋     | 226/480 [00:08<00:11, 22.19it/s] 48%|████▊     | 229/480 [00:08<00:11, 22.07it/s] 48%|████▊     | 232/480 [00:08<00:11, 21.96it/s] 49%|████▉     | 235/480 [00:09<00:11, 21.83it/s] 50%|████▉     | 238/480 [00:09<00:11, 21.72it/s] 50%|█████     | 241/480 [00:09<00:11, 21.60it/s] 51%|█████     | 244/480 [00:09<00:10, 21.49it/s] 51%|█████▏    | 247/480 [00:09<00:10, 21.38it/s] 52%|█████▏    | 250/480 [00:09<00:10, 21.27it/s] 53%|█████▎    | 253/480 [00:09<00:10, 21.16it/s] 53%|█████▎    | 256/480 [00:10<00:10, 21.04it/s] 54%|█████▍    | 259/480 [00:10<00:10, 20.94it/s] 55%|█████▍    | 262/480 [00:10<00:10, 20.85it/s] 55%|█████▌    | 265/480 [00:10<00:10, 20.77it/s] 56%|█████▌    | 268/480 [00:10<00:10, 20.67it/s] 56%|█████▋    | 271/480 [00:10<00:10, 20.57it/s] 57%|█████▋    | 274/480 [00:11<00:10, 20.47it/s] 58%|█████▊    | 277/480 [00:11<00:09, 20.37it/s] 58%|█████▊    | 280/480 [00:11<00:09, 20.25it/s] 59%|█████▉    | 283/480 [00:11<00:09, 20.15it/s] 60%|█████▉    | 286/480 [00:11<00:09, 20.05it/s] 60%|██████    | 289/480 [00:11<00:09, 19.94it/s] 61%|██████    | 291/480 [00:11<00:09, 19.88it/s] 61%|██████    | 293/480 [00:11<00:09, 19.81it/s] 61%|██████▏   | 295/480 [00:12<00:09, 19.72it/s] 62%|██████▏   | 297/480 [00:12<00:09, 19.64it/s] 62%|██████▏   | 299/480 [00:12<00:09, 19.56it/s] 63%|██████▎   | 301/480 [00:12<00:09, 19.49it/s] 63%|██████▎   | 303/480 [00:12<00:09, 19.43it/s] 64%|██████▎   | 305/480 [00:12<00:09, 19.38it/s] 64%|██████▍   | 307/480 [00:12<00:08, 19.33it/s] 64%|██████▍   | 309/480 [00:12<00:08, 19.27it/s] 65%|██████▍   | 311/480 [00:12<00:08, 19.20it/s] 65%|██████▌   | 313/480 [00:13<00:08, 19.14it/s] 66%|██████▌   | 315/480 [00:13<00:08, 19.08it/s] 66%|██████▌   | 317/480 [00:13<00:08, 19.02it/s] 66%|██████▋   | 319/480 [00:13<00:08, 18.96it/s] 67%|██████▋   | 321/480 [00:13<00:08, 18.90it/s] 67%|██████▋   | 323/480 [00:13<00:08, 18.85it/s] 68%|██████▊   | 325/480 [00:13<00:08, 18.75it/s] 68%|██████▊   | 327/480 [00:13<00:08, 18.70it/s] 69%|██████▊   | 329/480 [00:13<00:08, 18.65it/s] 69%|██████▉   | 331/480 [00:13<00:08, 18.59it/s] 69%|██████▉   | 333/480 [00:14<00:07, 18.53it/s] 70%|██████▉   | 335/480 [00:14<00:07, 18.47it/s] 70%|███████   | 337/480 [00:14<00:07, 18.42it/s] 71%|███████   | 339/480 [00:14<00:07, 18.36it/s] 71%|███████   | 341/480 [00:14<00:07, 18.32it/s] 71%|███████▏  | 343/480 [00:14<00:07, 18.29it/s] 72%|███████▏  | 345/480 [00:14<00:07, 18.26it/s] 72%|███████▏  | 347/480 [00:14<00:07, 18.20it/s] 73%|███████▎  | 349/480 [00:14<00:07, 18.15it/s] 73%|███████▎  | 351/480 [00:15<00:07, 18.09it/s] 74%|███████▎  | 353/480 [00:15<00:07, 18.03it/s] 74%|███████▍  | 355/480 [00:15<00:06, 17.97it/s] 74%|███████▍  | 357/480 [00:15<00:06, 17.92it/s] 75%|███████▍  | 359/480 [00:15<00:06, 17.87it/s] 75%|███████▌  | 361/480 [00:15<00:06, 17.82it/s] 76%|███████▌  | 363/480 [00:15<00:06, 17.77it/s] 76%|███████▌  | 365/480 [00:15<00:06, 17.72it/s] 76%|███████▋  | 367/480 [00:15<00:06, 17.68it/s] 77%|███████▋  | 369/480 [00:16<00:06, 17.61it/s] 77%|███████▋  | 371/480 [00:16<00:06, 17.56it/s] 78%|███████▊  | 373/480 [00:16<00:06, 17.50it/s] 78%|███████▊  | 375/480 [00:16<00:06, 17.44it/s] 79%|███████▊  | 377/480 [00:16<00:05, 17.39it/s] 79%|███████▉  | 379/480 [00:16<00:05, 17.35it/s] 79%|███████▉  | 381/480 [00:16<00:05, 17.32it/s] 80%|███████▉  | 383/480 [00:16<00:05, 17.28it/s] 80%|████████  | 385/480 [00:17<00:05, 17.23it/s] 81%|████████  | 387/480 [00:17<00:05, 17.18it/s] 81%|████████  | 389/480 [00:17<00:05, 17.14it/s] 81%|████████▏ | 391/480 [00:17<00:05, 17.09it/s] 82%|████████▏ | 393/480 [00:17<00:05, 17.05it/s] 82%|████████▏ | 395/480 [00:17<00:04, 17.01it/s] 83%|████████▎ | 397/480 [00:17<00:04, 16.96it/s] 83%|████████▎ | 399/480 [00:17<00:04, 16.92it/s] 84%|████████▎ | 401/480 [00:17<00:04, 16.87it/s] 84%|████████▍ | 403/480 [00:18<00:04, 16.81it/s] 84%|████████▍ | 405/480 [00:18<00:04, 16.76it/s] 85%|████████▍ | 407/480 [00:18<00:04, 16.72it/s] 85%|████████▌ | 409/480 [00:18<00:04, 16.68it/s] 86%|████████▌ | 411/480 [00:18<00:04, 16.63it/s] 86%|████████▌ | 413/480 [00:18<00:04, 16.59it/s] 86%|████████▋ | 415/480 [00:18<00:03, 16.54it/s] 87%|████████▋ | 417/480 [00:18<00:03, 16.50it/s] 87%|████████▋ | 419/480 [00:19<00:03, 16.46it/s] 88%|████████▊ | 421/480 [00:19<00:03, 16.42it/s] 88%|████████▊ | 423/480 [00:19<00:03, 16.38it/s] 89%|████████▊ | 425/480 [00:19<00:03, 16.33it/s] 89%|████████▉ | 427/480 [00:19<00:03, 16.29it/s] 89%|████████▉ | 429/480 [00:19<00:03, 16.26it/s] 90%|████████▉ | 431/480 [00:19<00:03, 16.23it/s] 90%|█████████ | 433/480 [00:19<00:02, 16.20it/s] 91%|█████████ | 435/480 [00:20<00:02, 16.16it/s] 91%|█████████ | 437/480 [00:20<00:02, 16.12it/s] 91%|█████████▏| 439/480 [00:20<00:02, 16.09it/s] 92%|█████████▏| 441/480 [00:20<00:02, 16.05it/s] 92%|█████████▏| 443/480 [00:20<00:02, 16.00it/s] 93%|█████████▎| 445/480 [00:20<00:02, 15.97it/s] 93%|█████████▎| 447/480 [00:20<00:02, 15.92it/s] 94%|█████████▎| 449/480 [00:20<00:01, 15.88it/s] 94%|█████████▍| 451/480 [00:21<00:01, 15.84it/s] 94%|█████████▍| 453/480 [00:21<00:01, 15.80it/s] 95%|█████████▍| 455/480 [00:21<00:01, 15.76it/s] 95%|█████████▌| 457/480 [00:21<00:01, 15.72it/s] 96%|█████████▌| 459/480 [00:21<00:01, 15.68it/s] 96%|█████████▌| 461/480 [00:21<00:01, 15.64it/s] 96%|█████████▋| 463/480 [00:21<00:01, 15.59it/s] 97%|█████████▋| 465/480 [00:21<00:00, 15.54it/s] 97%|█████████▋| 467/480 [00:22<00:00, 15.50it/s] 98%|█████████▊| 469/480 [00:22<00:00, 15.47it/s] 98%|█████████▊| 471/480 [00:22<00:00, 15.43it/s] 99%|█████████▊| 473/480 [00:22<00:00, 15.39it/s] 99%|█████████▉| 475/480 [00:22<00:00, 15.35it/s] 99%|█████████▉| 477/480 [00:22<00:00, 15.31it/s]100%|█████████▉| 479/480 [00:22<00:00, 15.28it/s]100%|██████████| 480/480 [00:22<00:00, 20.94it/s]
Cached Size: 48000 | Max Budget: 48200 | Start Size: 64 | Recent Size: 4756 | Gamma: 128 | Skip Start Layers: 1
Traceback (most recent call last):
  File "/home/hanshis/workspace/LongContextInfer/benchmark_flash_streamllm.py", line 60, in <module>
    outputs = model(
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/hanshis/workspace/LongContextInfer/models/modeling_llama_flash.py", line 965, in forward
    outputs = self.model(
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/hanshis/workspace/LongContextInfer/models/modeling_llama_flash.py", line 855, in forward
    layer_outputs = decoder_layer(
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/hanshis/workspace/LongContextInfer/models/modeling_llama_flash.py", line 602, in forward
    hidden_states, self_attn_weights, present_key_value = self.self_attn(
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/hanshis/anaconda3/envs/torch/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/hanshis/workspace/LongContextInfer/models/modeling_llama_flash.py", line 530, in forward
    k, v = past_key_value.speculation_update(k, v, self.layer_idx)
  File "/home/hanshis/workspace/LongContextInfer/models/cache_utils.py", line 456, in speculation_update
    self.cached_key[layer_idx][:, self.seq_len : self.seq_len + key_states.shape[-3]] = key_states
RuntimeError: The expanded size of the tensor (0) must match the existing size (128) at non-singleton dimension 1.  Target sizes: [1, 0, 32, 128].  Tensor sizes: [128, 32, 128]
